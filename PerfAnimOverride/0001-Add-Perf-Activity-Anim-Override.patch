From f89e8fa592233d86ad2cabf81df245c4003587cb Mon Sep 17 00:00:00 2001
From: rmp22 <195054967+rmp22@users.noreply.github.com>
Date: Wed, 27 Aug 2025 18:26:05 +0800
Subject: [PATCH] [BUGFIX] add perf activity anim override

fix for mtk and low-end devices perf regression caused by fixed dp translate and fade animation

Change-Id: Ifee7edcc1fecca034007e9afd9a9cf61704aa869
Signed-off-by: rmp22 <195054967+rmp22@users.noreply.github.com>
---
 .../view/animation/AnimationUtils.java        | 137 ++++++++++++++++++
 1 file changed, 137 insertions(+)

diff --git a/core/java/android/view/animation/AnimationUtils.java b/core/java/android/view/animation/AnimationUtils.java
index 8a407c3252f0c..1f3f8f7428773 100644
--- a/core/java/android/view/animation/AnimationUtils.java
+++ b/core/java/android/view/animation/AnimationUtils.java
@@ -30,11 +30,15 @@
 import android.content.res.Resources.Theme;
 import android.content.res.XmlResourceParser;
 import android.os.SystemClock;
+import android.os.SystemProperties;
 import android.util.AttributeSet;
+import android.util.DisplayMetrics;
 import android.util.TimeUtils;
 import android.util.Xml;
 import android.view.InflateException;
 
+import com.android.internal.R;
+
 import org.xmlpull.v1.XmlPullParser;
 import org.xmlpull.v1.XmlPullParserException;
 
@@ -216,6 +220,20 @@ public static long getExpectedPresentationTimeMillis() {
     public static Animation loadAnimation(Context context, @AnimRes int id)
             throws NotFoundException {
 
+        if (SystemProperties.getBoolean("persist.sys.activity_anim_perf_override", true)) {
+            ActivityAnimations.maybeInit(context);
+            switch (id) {
+                case R.anim.activity_open_enter:
+                    return ActivityAnimations.getOpenEnter();
+                case R.anim.activity_open_exit:
+                    return ActivityAnimations.getOpenExit();
+                case R.anim.activity_close_enter:
+                    return ActivityAnimations.getCloseEnter();
+                case R.anim.activity_close_exit:
+                    return ActivityAnimations.getCloseExit();
+            }
+        }
+
         XmlResourceParser parser = null;
         try {
             parser = context.getResources().getAnimation(id);
@@ -496,4 +514,123 @@ private static Interpolator createInterpolatorFromXml(
         }
         return interpolator;
     }
+
+    /** @hide */
+    public final class ActivityAnimations {
+
+        private static Animation sOpenEnter;
+        private static Animation sOpenExit;
+        private static Animation sCloseEnter;
+        private static Animation sCloseExit;
+
+        private static Interpolator sLinearOutSlowInInterpolator;
+        private static float sScaleRatio;
+        private static float sDensity;
+
+        private static final long DEFAULT_DURATION = 133L;
+
+        private ActivityAnimations() {}
+
+        /** @hide */
+        public static void maybeInit(Context context) {
+            if (sLinearOutSlowInInterpolator == null) {
+                sLinearOutSlowInInterpolator = AnimationUtils.loadInterpolator(
+                        context, R.interpolator.linear_out_slow_in);
+            }
+            if (sDensity == 0f) {
+                DisplayMetrics dm = context.getResources().getDisplayMetrics();
+                float sw = Math.min(dm.widthPixels, dm.heightPixels) / dm.density;
+                sScaleRatio = sw / 420f;
+                sDensity = dm.density;
+            }
+        }
+
+        private static float scaledDp(float dp) {
+            return dp * sDensity * sScaleRatio;
+        }
+
+        private static class ActivityAnimFactory {
+            private float fromX, toX, fromY, toY;
+            private long duration = DEFAULT_DURATION;
+            private Interpolator interpolator = sLinearOutSlowInInterpolator;
+
+            public ActivityAnimFactory fromX(float dp) {
+                this.fromX = scaledDp(dp);
+                return this;
+            }
+
+            public ActivityAnimFactory toX(float dp) {
+                this.toX = scaledDp(dp);
+                return this;
+            }
+
+            public ActivityAnimFactory duration(long duration) {
+                this.duration = duration;
+                return this;
+            }
+
+            public ActivityAnimFactory interpolator(Interpolator interpolator) {
+                this.interpolator = interpolator;
+                return this;
+            }
+
+            public Animation build() {
+                TranslateAnimation slide = new TranslateAnimation(
+                        Animation.ABSOLUTE, fromX,
+                        Animation.ABSOLUTE, toX,
+                        Animation.ABSOLUTE, 0f,
+                        Animation.ABSOLUTE, 0f
+                );
+                slide.setDuration(duration);
+                slide.setInterpolator(interpolator);
+                AnimationSet set = new AnimationSet(false);
+                set.addAnimation(slide);
+                return set;
+            }
+        }
+
+        /** @hide */
+        public static Animation getOpenEnter() {
+            if (sOpenEnter == null) {
+                sOpenEnter = new ActivityAnimFactory()
+                        .fromX(48)
+                        .toX(0)
+                        .build();
+            }
+            return sOpenEnter;
+        }
+
+        /** @hide */
+        public static Animation getOpenExit() {
+            if (sOpenExit == null) {
+                sOpenExit = new ActivityAnimFactory()
+                        .fromX(0)
+                        .toX(-48)
+                        .build();
+            }
+            return sOpenExit;
+        }
+
+        /** @hide */
+        public static Animation getCloseEnter() {
+            if (sCloseEnter == null) {
+                sCloseEnter = new ActivityAnimFactory()
+                        .fromX(-48)
+                        .toX(0)
+                        .build();
+            }
+            return sCloseEnter;
+        }
+
+        /** @hide */
+        public static Animation getCloseExit() {
+            if (sCloseExit == null) {
+                sCloseExit = new ActivityAnimFactory()
+                        .fromX(0)
+                        .toX(48)
+                        .build();
+            }
+            return sCloseExit;
+        }
+    }
 }
